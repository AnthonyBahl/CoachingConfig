<div class="container-fluid">
    <div class="row">
        <div class="col-3">
            <h4>All Expectations</h4>
        </div>
        <div class="col-5 text-end">
            <input type="text" class="form-control" id="searchInput" placeholder="Search...">
        </div>
        <div class="form-check form-switch col-2 align-items-end">
            <label class="form-check-label" for="flexSwitchCheckDefault">
                Archives
            </label>
            <input class="form-check-input" type="checkbox" role="switch" id="archiveSwitch">
        </div>
        <div class="col-2 text-center">
            <button type="button" class="btn btn-success add-button">
                <span class="material-symbols-outlined align-middle">add</span>
                <span class="align-middle">Add</span>
            </button>
        </div>
    </div>
</div>
<!-- Info/Calculator -->
<svg xmlns="http://www.w3.org/2000/svg" class="d-none">
    <symbol id="copy" viewBox="0 -960 960 960">
        <path
            d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z" />
</svg>
<div id="calculatorSection" class="bd-callout bd-callout-info d-none">
    <button class="btn-close float-end" aria-label="Close"></button>
    <h4 class="mb-2">Coaching Calculator</h4>
    <p><strong>Instructions:</strong> Values entered as expectations indicate the number of
        coachings per 160 hours. For assistance calculating that value, use the calculator below.
    </p>
    <div class="row">
        <div class="col-4">
            <div class="input-group mb-3">
                <span class="input-group-text">Agent's Weekly Hours</span>
                <input class="form-control" type="number" id="weeklyHours" min="1" step="1">
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-5">
            <div class="input-group mb-3">
                <span class="input-group-text">Desired Monthly Coachings</span>
                <input class="form-control" type="number" id="monthlyCoachings" min="0" step="1">
            </div>
        </div>
    </div>
    <button class="btn btn-primary mb-3" id="calculateBtn">Calculate</button>
    <div id="outputBox"></div>
</div>
<script>
    $(document).ready(function () {
        $('.btn-close').click(function () {
            $(this).closest('.bd-callout').addClass('d-none');
        });


        $('#calculateBtn').click(function () {
            const weeklyHours = parseFloat($('#weeklyHours').val());
            const monthlyCoachings = parseFloat($('#monthlyCoachings').val());

            if (isNaN(weeklyHours) || isNaN(monthlyCoachings)) {
                new AlertBuilder('Error', "Please enter valid numbers in both fields.").build();
                return;
            }

            const coachingsPer160Hours = (160 / (weeklyHours * 4)) * monthlyCoachings;

            // Generate inner HTML for the output box
            const outputHTML = `<div class="container-fluid>
                                                            <div class="row">
                                                            <div class="col-5">
                                                                <div class="input-group mb-3">
                                                                    <span class="input-group-text">Coachings every 160 Hours: </span>
                                                                    <input type="text" class="form-control" value="${coachingsPer160Hours.toFixed(2)}" readonly>
                                                                    <button class="btn btn-outline-secondary" id="copyBtn"><svg height="24" width="24"><use xlink:href="#copy" /></svg></button>
                                                                </div>
                                                            </div>
                                                        </div>`;

            $('#outputBox').html(outputHTML);

            // Use event delegation for the dynamic button
            $(document).on('click', '#copyBtn', function () {
                const copyText = $(this).prevAll('input').first();
                copyText.select();
                document.execCommand("copy");
                AlertBuilder.showToast('Copied!', 4000);
            });

        });
    });
</script>
<!-- Info/Calculator End -->
<div class="table-responsive">
    <table class="table table-hover mt-3">
        <thead>
            <th scope="col">Type</th>
            <th scope="col">Name</th>
            <th scope="col" class="text-center">Performance</th>
            <th scope="col" class="text-center">1-to-1</th>
            <th scope="col" class="text-center">
                Side-by-side
                <sup data-bs-toggle="tooltip" title="Click here for info.">
                    <svg xmlns="http://www.w3.org/2000/svg" height="15" viewBox="0 -960 960 960" width="15"
                        style="fill: var(--bs-primary);">
                        <path
                            d="M478-240q21 0 35.5-14.5T528-290q0-21-14.5-35.5T478-340q-21 0-35.5 14.5T428-290q0 21 14.5 35.5T478-240Zm-36-154h74q0-33 7.5-52t42.5-52q26-26 41-49.5t15-56.5q0-56-41-86t-97-30q-57 0-92.5 30T342-618l66 26q5-18 22.5-39t53.5-21q32 0 48 17.5t16 38.5q0 20-12 37.5T506-526q-44 39-54 59t-10 73Zm38 314q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
                    </svg>
                </sup>
            </th>
            <th scope="col" class="text-center">Start Date</th>
            <th scope="col" class="text-center">End Date</th>
            <th scope="colgroup" colspan="2">Actions</th>
        </thead>
        <tbody id="newAdds"></tbody>
        <tbody id="changes"></tbody>
        <tbody id="searchResults"></tbody>
    </table>
</div>
<template id="newAddsTemplate">
    <tr>
        <td class="type">
            <select class="form-select expectation-type-dropdown">
                <!-- JavaScript will populate this -->
            </select>
        </td>
        <td class="name">
            <div class="d-flex justify-content-center">
                <input type="text" class="form-control text-center name-input" min="0" step="0.001" disabled>
                <datalist class="data-list"></datalist>
            </div>
        </td>
        <td class="performance text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center" min="0" step="0.001" style="width: 100px;">
            </div>
        </td>
        <td class="oneToOne text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center" min="0" step="0.001" style="width: 100px;">
            </div>
        </td>
        <td class="sideBySide text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center" min="0" step="0.001" style="width: 100px;">
            </div>
        </td>
        <td class="startDate text-center">
            <div class="d-flex justify-content-center">
                <input type="date" class="form-control" style="width: 140px;">
            </div>
        </td>
        <td class="endDate text-center">
            <div class="d-flex justify-content-center">
                <input type="date" class="form-control" style="width: 120px;">
            </div>
        </td>
        <td>
            <button type="button" class="btn btn-outline-success save-button" disabled>Save</button>
        </td>
        <td>
            <button type="button" class="btn btn-outline-dark cancel-button">Cancel</button>
        </td>
    </tr>
</template>
<template id="changeRowTemplate">
    <tr>
        <td class="type"></td>
        <td class="name"></td>
        <td class="text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center performance-input" min="0" step="0.001"
                    style="width: 100px;" />
            </div>
        </td>
        <td class="text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center oneToOne-input" min="0" step="0.001"
                    style="width: 100px;" />
            </div>
        </td>
        <td class="text-center">
            <div class="d-flex justify-content-center">
                <input type="number" class="form-control text-center sideBySide-input" min="0" step="0.001"
                    style="width: 100px;" />
            </div>
        </td>
        <td class="startDate text-center">
            <div class="d-flex justify-content-center">
                <input type="date" class="form-control startDate-input" style="width: 140px;" />
            </div>
        </td>
        <td class="endDate text-center">
            <div class="d-flex justify-content-center">
                <input type="date" class="form-control endDate-input" style="width: 140px;" />
            </div>
        </td>
        <td>
            <button type="button" class="btn btn-outline-success save-button">Save</button>
        </td>
        <td>
            <button type="button" class="btn btn-outline-dark cancel-button">Cancel</button>
        </td>
    </tr>
</template>
<template id="searchRowTemplate">
    <tr>
        <td class="type"></td>
        <td class="name"></td>
        <td class="performance text-center"></td>
        <td class="oneToOne text-center"></td>
        <td class="sideBySide text-center"></td>
        <td class="startDate text-center"></td>
        <td class="endDate text-center"></td>
        <td>
            <button type="button" class="btn btn-outline-primary edit-button">Edit</button>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger archive-button">Archive</button>
        </td>
    </tr>
</template>
<script>

    // Toggles visibility of info section
    $(document).ready(function () {
        // Initialize Bootstrap tooltip
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Toggle visibility of #calculatorSection
        $('sup').click(function () {
            $('#calculatorSection').toggleClass('d-none');
        });
    });


    var expectationData = [];


    function getExpectationData() {
        try {
            expectationData = [];
            Object.entries(DATABASE.DATA.expectationData).forEach(([id, expectationObject]) => {
                const { expectationType, resourceId, performance, oneToOne, sideBySide, startDate, endDate, active } = expectationObject;
                let tempRow = [id, expectationType];
                let resourceName;
                try {
                    resourceName = DATABASE.getResourceName(resourceId, expectationType)
                } catch (error) {
                    AlertBuilder.handleError(error);
                }
                tempRow.push(resourceName, performance, oneToOne, sideBySide, formatDate(startDate), formatDate(endDate), resourceId, active);
                expectationData.push(tempRow);
            });

            //updateResultsBox(expectationData);
            search();

        } catch (e) {
            console.error('An error occurred:', e);
            AlertBuilder.handleError(e);
        }
    }
    getExpectationData(); // Call to immediately initialize

    function formatDate(date) {
        return new Date(date).toISOString().split('T')[0];
    }

    function updateResultsBox(dataArray) {
        const archiveSwitch = document.getElementById('archiveSwitch').checked;
        dataArray = dataArray.filter(row => archiveSwitch || row[9]); // Checks the 'active' field

        // Collect expectation IDs that are already in the changes box portion of the table
        const changesBox = document.getElementById('changes');
        const existingIds = Array.from(changesBox.querySelectorAll('tr')).map(tr => tr.dataset.expectationId);

        // Exclude rows that are already in changes
        dataArray = dataArray.filter(row => !existingIds.includes(row[0]));

        dataArray.sort((a, b) => b[6].localeCompare(a[6]));
        dataArray = dataArray.slice(0, 12);
        const searchResultsBox = document.getElementById("searchResults");
        const templateRow = document.getElementById("searchRowTemplate").content;

        searchResultsBox.innerHTML = '';

        dataArray.forEach(rowData => {
            const tr = templateRow.cloneNode(true);

            // Set the expectation ID as a data attribute for the entire row (<tr>)
            const expectationId = rowData[0];
            tr.querySelector('tr').dataset.expectationId = expectationId;

            // Populate the cells
            ['type', 'name', 'performance', 'oneToOne', 'sideBySide', 'startDate', 'endDate'].forEach((className, index) => {
                tr.querySelector(`.${className}`).textContent = rowData[index + 1];
            });

            // Conditionally update buttons
            if (rowData[9] === false) {
                const reActivateButton = `<button type="button" class="btn btn-outline-success reActivate-button" data-expectation-id="${expectationId}">Re-Activate</button>`;
                tr.querySelector('.edit-button').outerHTML = reActivateButton;
                tr.querySelector('.archive-button').remove();
            } else {
                tr.querySelector('.edit-button').dataset.expectationId = expectationId;
                tr.querySelector('.archive-button').dataset.expectationId = expectationId;
            }

            searchResultsBox.appendChild(tr);
        });
    }

    function search() {
        // Fetch and tokenize the user's search input
        const userInput = document.getElementById("searchInput").value;
        const searchTerms = userInput.toLowerCase().split(" ").filter(term => term.length > 0);

        // Filter the expectationData array based on search input
        const filteredExpectations = expectationData.filter(row => {
            return searchTerms.every(term => {
                // Check for ID search pattern
                if (term.startsWith("id{") && term.endsWith("}")) {
                    const id = term.substring(3, term.length - 1);
                    return row[0] === id;
                }
                // Otherwise search in the "Type" and "Name" columns
                return [row[1], row[2]].some(field => String(field).toLowerCase().includes(term));
            });
        });

        // Update the display with filtered results
        updateResultsBox(filteredExpectations);
    }

    /* Start of Validator classes, each class validates a different type of field. */
    class Validator {
        validate() {
            throw new Error("Abstract method!");
        }
    }

    class CoachingNumberValidator extends Validator {
        validate(field) {
            const value = parseFloat(field.value);
            return isNaN(value) || value < 0;
        }
    }

    class StartDateValidator extends Validator {
        validate(field) {
            const startDateValue = new Date(field.value);
            const endDateValue = new Date(field.closest('tr').querySelector('.endDate-input').value);
            return isNaN(startDateValue) || startDateValue.getFullYear() < 1990 || startDateValue > endDateValue;
        }
    }

    class EndDateValidator extends Validator {
        validate(field) {
            const endDateValue = new Date(field.value);
            const startDateValue = new Date(field.closest('tr').querySelector('.startDate-input').value);
            return isNaN(endDateValue) || endDateValue.getFullYear() > 3000 || endDateValue < startDateValue;
        }
    }
    /* End of Validator classes. */

    // Factory to create Validators.
    const validatorFactory = {
        createValidator(type) {
            switch (type) {
                case "CoachingNumber":
                    return new CoachingNumberValidator();
                case "StartDate":
                    return new StartDateValidator();
                case "EndDate":
                    return new EndDateValidator();
                default:
                    throw new Error("Invalid validator type!");
            }
        }
    };

    // Refactor common code into a separate function
    function validateField(e, validatorType) {
        const field = e.target;
        const validator = validatorFactory.createValidator(validatorType);

        if (validator.validate(field)) {
            field.classList.add('is-invalid');
        } else {
            field.classList.remove('is-invalid');
            const closestRow = field.closest('tr');
            validateRow(closestRow);
        }
    }

    function validateRow(row) {
        const saveButton = row.querySelector('.save-button');
        const inputs = row.querySelectorAll('input');

        const validated = Array.from(inputs).every(input => !input.classList.contains('is-invalid'));

        if (validated) {
            saveButton.classList.remove('disabled');
        } else {
            saveButton.classList.add('disabled');
        }
    }


    // Refactor the call of validateField function and pass the validator type as a parameter
    function handleFieldChange(e, validatorType) {
        // Any actions that need to happen prior to validation could be placed here
        validateField(e, validatorType);
    }

    function handleCancelButton(e) {
        const parentRow = $(e.target).closest('tr');
        parentRow.fadeOut('slow', function () {
            parentRow.remove();
        });
        search();
    }

    function handleEditButton(e) {
        // Add Row to changes
        const expectationId = e.target.dataset.expectationId;
        try {
            if (DATABASE.DATA.expectationData[expectationId]) {
                const expectationObject = DATABASE.DATA.expectationData[expectationId];
                const changesBox = document.getElementById("changes");
                const template = document.getElementById("changeRowTemplate").content.cloneNode(true);
                template.querySelector('tr').dataset.expectationId = expectationId;
                let resourceName;
                try {
                    resourceName = DATABASE.getResourceName(expectationObject.resourceId, expectationObject.expectationType)
                } catch (error) {
                    throw error;
                }
                const performanceInput = template.querySelector('.performance-input');
                const oneToOneInput = template.querySelector('.oneToOne-input');
                const sideBySideInput = template.querySelector('.sideBySide-input');
                const startDateInput = template.querySelector('.startDate-input');
                const endDateinput = template.querySelector('.endDate-input');
                const saveButton = template.querySelector('.save-button');
                const cancelButton = template.querySelector('.cancel-button');

                // Set Values
                template.querySelector('.type').textContent = expectationObject.expectationType;
                template.querySelector('.name').textContent = resourceName;
                performanceInput.value = `${expectationObject.performance}`;
                oneToOneInput.value = `${expectationObject.oneToOne}`;
                sideBySideInput.value = `${expectationObject.sideBySide}`;
                startDateInput.value = `${formatDate(expectationObject.startDate)}`;
                endDateinput.value = `${formatDate(expectationObject.endDate)}`;

                // Set Event Listeners
                performanceInput.addEventListener('change', (e) => handleFieldChange(e, 'CoachingNumber'));
                oneToOneInput.addEventListener('change', (e) => handleFieldChange(e, 'CoachingNumber'));
                sideBySideInput.addEventListener('change', (e) => handleFieldChange(e, 'CoachingNumber'));
                startDateInput.addEventListener('change', (e) => handleFieldChange(e, 'StartDate'));
                endDateinput.addEventListener('change', (e) => handleFieldChange(e, 'EndDate'));
                saveButton.addEventListener('click', (e) => handleSaveButton(e));
                cancelButton.addEventListener('click', (e) => handleCancelButton(e));

                // Set Data Attributes
                saveButton.dataset.expectationId = expectationId;
                cancelButton.dataset.expectationId = expectationId;
                changesBox.appendChild(template);
                search();
            } else {
                throw new Error(`Could not find expection id # ${expectationId}`);
            }
        } catch (error) {
            AlertBuilder.handleError(error);
        }
    }

    function handleArchiveButton(e) {
        const archiveButton = e.target,
            parentRow = archiveButton.closest('tr'),
            editButton = parentRow.querySelector('.edit-button');
        try {
            // Disable the editButton & clear archiveButton
            editButton.classList.add('disabled');
            archiveButton.innerHTML = '';
            createSpinner(archiveButton);
            const isArchived = DATABASE.setExpectationActiveStatus(
                archiveButton.dataset.expectationId,
                false,
                function () { // Success handler
                    getExpectationData();
                },
                function () { // Failure handler
                    resetButtons();
                }
            );
            // only re-enable the editButton & reset archiveButton in case of failure
            if (!isArchived) resetButtons();
        } catch (error) {
            resetButtons();
            console.error('DATABASE operation failed:', error);
        }
        function resetButtons(label) {
            archiveButton.innerHTML = 'Archive';
            editButton.classList.remove('disabled');
        }
    }

    // ToDo: Optimize this
    function handleSaveButton(e) {
        const parentRow = e.target.closest('tr');
        const cancelButton = parentRow.querySelector('.cancel-button');
        cancelButton.classList.add('disabled');
        // Replace the button text with a Bootstrap spinning loader
        e.target.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        const expectation = e.target.dataset.expectationId ? DATABASE.DATA.expectationData[e.target.dataset.expectationId] : {};
        const performanceField = parentRow.querySelector('.performance-input');
        performanceField.classList.add('disabled');
        performanceField.disabled = true;
        const oneToOneField = parentRow.querySelector('.oneToOne-input');
        oneToOneField.classList.add('disabled');
        oneToOneField.disabled = true;
        const sideBySideField = parentRow.querySelector('.sideBySide-input');
        sideBySideField.classList.add('disabled');
        sideBySideField.disabled = true;
        const startDateField = parentRow.querySelector('.startDate-input');
        startDateField.classList.add('disabled');
        startDateField.disabled = true;
        const endDateField = parentRow.querySelector('.endDate-input');
        endDateField.classList.add('disabled');
        endDateField.disabled = true;

        const performanceValue = parseFloat(performanceField.value);
        const oneToOneValue = parseFloat(oneToOneField.value);
        const sideBySideValue = parseFloat(sideBySideField.value);

        expectation.performance = performanceValue;
        expectation.oneToOne = oneToOneValue;
        expectation.sideBySide = sideBySideValue;
        expectation.startDate = startDateField.value;
        expectation.endDate = endDateField.value;
        if (e.target.closest('tbody').id === 'newAdds') {
            const typeField = parentRow.querySelector('.expectation-type-dropdown');
            const nameField = parentRow.querySelector('.name-input');
            typeField.disabled = true;
            nameField.disabled = true;
            expectation.expectationType = typeField.value;
            const nameValue = nameField.value;
            if (expectation.expectationType === 'Default') {
                expectation.resourceId = -1;
            } else {
                if (expectation.type === 'Default') {
                    expectation.resourceId = -1;
                } else {
                    // Parse string for ID
                    console.log(`Parsing ${nameValue}`);
                    const lastOpenParenIndex = nameValue.lastIndexOf('(');
                    const closeParenIndex = nameValue.indexOf(')', lastOpenParenIndex);
                    if (lastOpenParenIndex !== -1 && closeParenIndex !== -1) {
                        console.log(`( is at ${lastOpenParenIndex} and ) is at ${closeParenIndex}`);
                        expectation.resourceId = parseInt(nameValue.substring(lastOpenParenIndex + 1, closeParenIndex));
                        console.log(`id value is: ${expectation.resourceId}`);
                    }
                }
            }
            expectation.active = true;
            // Pass callbacks to handle success and failure scenarios
            DATABASE.addExpectation(
                expectation,
                function () {  // Success handler
                    const parentRow = $(e.target).closest('tr');
                    parentRow.fadeOut('slow', function () {
                        parentRow.remove();
                    });
                    getExpectationData();
                },
                () => {  // Failure handler
                    endDateField.disabled = false;
                    startDateField.disabled = false;
                    sideBySideField.disabled = false;
                    oneToOneField.disabled = false;
                    performanceField.disabled = false;
                    typeField.disabled = false;
                    nameField.disabled = false;
                    e.target.innerHTML = 'Save';
                    cancelButton.classList.remove('disabled');
                }
            );

        } else {
            // Pass callbacks to handle success and failure scenarios
            DATABASE.updateExpectation(
                e.target.dataset.expectationId,
                expectation,
                function () {  // Success handler
                    const parentRow = $(e.target).closest('tr');
                    parentRow.fadeOut('slow', function () {
                        parentRow.remove();
                    });
                    getExpectationData();
                },
                () => {  // Failure handler
                    endDateField.disabled = false;
                    startDateField.disabled = false;
                    sideBySideField.disabled = false;
                    oneToOneField.disabled = false;
                    performanceField.disabled = false;
                    e.target.innerHTML = 'Save';
                    cancelButton.classList.remove('disabled');
                }
            );
        }
    }

    const handleReActivateButton = (event) => {
        const button = event.target;
        const expectationId = button.dataset.expectationId;
        if (!expectationId) {
            // Defensive check for existence of required dataset 
            console.error("Unable to get expectationId");
            const error = new Error("Unable to get Expectation ID");
            AlertBuilder.handleError(error);
        }

        createSpinner(button); // Optimization and Creating more modular code 

        DATABASE.setExpectationActiveStatus(
            expectationId,
            true,
            () => onSuccess(event), // Optimization
            () => onError(button)); // Optimization

        const onSuccess = (event) => {
            const buttonElement = event.target;
            const parentRow = $(buttonElement).closest('tr');
            parentRow.fadeOut('slow', () => parentRow.remove());
            getExpectationData();
        }

        const onError = (buttonElement) => {
            buttonElement.innerHTML = 'Re-Activate'; // Unexpected event handler 
        }
    };

    const createSpinner = (buttonElement) => {
        const spinner = document.createElement('span');
        spinner.classList.add('spinner-border', 'spinner-border-sm');
        spinner.setAttribute('role', 'status'); //Using the setAttribute function is more readable and a best practice
        buttonElement.innerHTML = '';
        buttonElement.appendChild(spinner);
    }

    //ToDo: optimize this
    // Make template better so that we don't have to define as much in javascript
    function handleAddbutton() {

        const tBody = document.getElementById("newAdds");
        const templateRow = document.getElementById("newAddsTemplate").content;
        const tr = templateRow.cloneNode(true);
        const dropdown = tr.querySelector('.expectation-type-dropdown');  // Added the period before the class name
        const expectationTypes = DATABASE.expectationTypes;
        // Generate a unique identifier (you can use any strategy you like)
        const uniqueID = `data-list-${new Date().getTime()}`;
        const dataList = tr.querySelector('.data-list');
        const nameInput = tr.querySelector('.name-input');
        const saveButton = tr.querySelector('.save-button');
        dataList.id = uniqueID;
        nameInput.setAttribute('list', uniqueID);
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.innerText = '';
        dropdown.appendChild(defaultOption);

        expectationTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.innerText = type;
            dropdown.appendChild(option);  // Changed from dropdownTemplate
        });

        // Add the event listener to this specific dropdown
        dropdown.addEventListener('change', function (event) {
            const type = event.target.value;
            const nameInput = event.target.closest('tr').querySelector('.name-input');
            const clearDataList = () => {
                dataList.innerHTML = "";
            };

            const appendOption = (label) => {
                const option = document.createElement("option");
                option.value = label;
                dataList.appendChild(option);
            };

            switch (type) {
                case 'Default':
                    nameInput.value = 'All Agents';
                    nameInput.disabled = true;
                    break;

                case 'Agent':
                    clearDataList();
                    Object.entries(DATABASE.DATA.employeeData).forEach(([id, employee]) => {
                        if (employee.level !== '' && employee.level <= 1) {
                            appendOption(`${employee.name} (${id})`);
                            nameInput.disabled = false;
                        }
                    });
                    break;

                case 'Workgroup':
                    clearDataList();
                    Object.entries(DATABASE.DATA.workgroupData).forEach(([id, workgroup]) => {
                        appendOption(`${workgroup} (${id})`);
                        nameInput.disabled = false;
                    });
                    break;

                case 'Job Profile':
                    clearDataList();
                    Object.entries(DATABASE.DATA.jobProfileData).forEach(([id, profile]) => {
                        appendOption(`${profile} (${id})`);
                        nameInput.disabled = false;
                    });
                    break;

                default:
                    // Do nothing
                    break;
            }
        });

        const validateAll = (e) => {
            const tableRow = e.target.closest('tr');
            let allValid = true;

            if (dropdown.value === '') {
                allValid = false;
            }

            if (allValid) {
                if (tableRow) {
                    const inputs = tableRow.querySelectorAll('input');
                    for (const input of inputs) {
                        // Check for is-invalid class or empty value
                        if (input.classList.contains('is-invalid') || input.value === '') {
                            allValid = false;
                            break;
                        }
                    }
                } else {
                    console.log("tr is null or undefined");
                }

            }
            saveButton.disabled = !allValid;
        }
        nameInput.addEventListener('change', function (e) {
            let isValid = false;

            // Retrieve all option elements in the datalist
            const options = dataList.querySelectorAll('option');

            // Check if the input value matches any of the datalist options
            for (const option of options) {
                if (option.value === nameInput.value) {
                    isValid = true;
                    break;
                }
            }
            if (isValid) {
                nameInput.classList.remove('is-invalid');
            } else {
                nameInput.classList.add('is-invalid');
            }
            validateAll(e);
        });
        const performanceField = tr.querySelector('.performance input');
        performanceField.addEventListener('input', function (e) {
            if (performanceField.value < 0 || performanceField.value === '') {
                performanceField.classList.add('is-invalid');
            } else {
                performanceField.classList.remove('is-invalid');
            }
            validateAll(e);
        });
        const oneToOneField = tr.querySelector('.oneToOne input');
        oneToOneField.addEventListener('input', function (e) {
            if (oneToOneField.value < 0 || oneToOneField.value === '') {
                oneToOneField.classList.add('is-invalid');
            } else {
                oneToOneField.classList.remove('is-invalid');
            }
            validateAll(e);
        });
        const sideBySideField = tr.querySelector('.sideBySide input');
        sideBySideField.addEventListener('input', function (e) {
            if (sideBySideField.value < 0 || sideBySideField.value === '') {
                sideBySideField.classList.add('is-invalid');
            } else {
                sideBySideField.classList.remove('is-invalid');
            }
            validateAll(e);
        });
        const startDateField = tr.querySelector('.startDate input');
        const endDateField = tr.querySelector('.endDate input');

        startDateField.addEventListener('input', function (e) {
            let isValid = true;
            const startDate = new Date(startDateField.value);
            const endDate = new Date(endDateField.value);

            if (startDateField.value === '' || startDate < new Date('1990-01-01') || (endDateField.value !== '' && startDate > endDate)) {
                isValid = false;
                startDateField.classList.add('is-invalid');
            } else {
                startDateField.classList.remove('is-invalid');
            }
            validateAll(e);
        });

        endDateField.addEventListener('input', function (e) {
            let isValid = true;
            const startDate = new Date(startDateField.value);
            const endDate = new Date(endDateField.value);

            if (endDateField.value === '' || endDate > new Date('3000-12-31') || (startDateField.value !== '' && endDate < startDate)) {
                isValid = false;
                endDateField.classList.add('is-invalid');
            } else {
                endDateField.classList.remove('is-invalid');
            }
            validateAll(e);
        });
        // Append the new row to the table
        tBody.appendChild(tr);
    }

    if (!document.ExpectationEventListenersAdded) {
        document.getElementById("searchInput").addEventListener("input", search);
        document.getElementById("archiveSwitch").addEventListener("change", search);
        // ToDo: remove these once everything just has event listeners built in.
        document.addEventListener("click", function (e) {
            const target = e.target.closest('button');
            if (target && target.classList) {
                if (target.classList.contains('edit-button')) {
                    handleEditButton(e);
                } else if (target.classList.contains('archive-button')) {
                    handleArchiveButton(e);
                } else if (target.classList.contains('cancel-button')) {
                    handleCancelButton(e);
                } else if (target.classList.contains('reActivate-button')) {
                    handleReActivateButton(e);
                } else if (target.classList.contains('add-button')) {
                    handleAddbutton(e);
                }
            }
        });
    }

    function validateFields(changesRow) {
        let validated = true;
        const performanceField = changesRow.querySelector('.performance input');
        const oneToOneField = changesRow.querySelector('.oneToOne input');
        const sideBySideField = changesRow.querySelector('.sideBySide input');
        const startDateField = changesRow.querySelector('.startDate input');
        const endDateField = changesRow.querySelector('.endDate input');

        const performanceValue = parseFloat(performanceField.value);
        const oneToOneValue = parseFloat(oneToOneField.value);
        const sideBySideValue = parseFloat(sideBySideField.value);
        const startDateValue = new Date(startDateField.value);
        const endDateValue = new Date(endDateField.value);

        // Validate performance
        if (isNaN(performanceValue) || performanceValue < 0) {
            performanceField.classList.add('is-invalid');
            validated = false;
        } else {
            performanceField.classList.remove('is-invalid');
        }

        // Validate oneToOne
        if (isNaN(oneToOneValue) || oneToOneValue < 0) {
            oneToOneField.classList.add('is-invalid');
            validated = false;
        } else {
            oneToOneField.classList.remove('is-invalid');
        }

        // Validate sideBySide
        if (isNaN(sideBySideValue) || sideBySideValue < 0) {
            sideBySideField.classList.add('is-invalid');
            validated = false;
        } else {
            sideBySideField.classList.remove('is-invalid');
        }

        // Validate startDate
        if (isNaN(startDateValue) || startDateValue.getFullYear() < 1990 || startDateValue > endDateValue) {
            startDateField.classList.add('is-invalid');
            validated = false;
        } else {
            startDateField.classList.remove('is-invalid');
        }

        // Validate endDate
        if (isNaN(endDateValue) || endDateValue.getFullYear() > 3000 || endDateValue < startDateValue) {
            endDateField.classList.add('is-invalid');
            validated = false;
        } else {
            endDateField.classList.remove('is-invalid');
        }

        // Enable or disable save button
        const saveButton = changesRow.querySelector('.save-button');
        if (validated) {
            saveButton.classList.remove('disabled');
        } else {
            saveButton.classList.add('disabled');
        }
    }
    document.ExpectationEventListenersAdded = true;
</script>